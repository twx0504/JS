<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator</title>
  </head>
  <body>
    <script type="module">
      import { urls, loadImagePromise } from "./async-methods.js";

      // Note: Without generatorRunner, we need to call next manually
      //   it.next().value.then((img) => {
      //     it.next(img).value.then((img) => {
      //       it.next(img).value.then((img) => {
      //         it.next(img).value.then((img) => {
      //           console.log(it.next(img).value);
      //         });
      //       });
      //     });
      //   });

      /**
       * A generator-based image loading method.
       * It is built on top of promise-based method.
       * It aims to simplifies async code
       *
       * @param {Array} urls
       * @returns {Promise} A promise
       */

      function* gen(urls) {
        const imgArr = [];
        for (const url of urls) {
          // This async code looks synchronous
          try {
            let img = yield loadImagePromise(url);
            imgArr.push(img);
          } catch (err) {
            console.log(err);
          }
        }
        return imgArr;
      }

      function runGenerator(gen, urls) {
        return new Promise((resolve, reject) => {
          // Generator runner
          const it = gen(urls);

          function next(val) {
            let res;
            try {
              res = it.next(val);
            } catch (err) {
              reject(err);
            }

            if (res.done) {
              resolve(res.value);
              return;
            }

            res.value
              .then((data) => {
                next(data);
              })
              .catch((err) => {
                reejct(err);
              });
          }

          next();
        });
      }

      // Promise + Generator simplifies async code
      runGenerator(gen, urls).then((imgs) => {
        for (const img of imgs) {
          document.body.appendChild(img);
        }
      });
    </script>
  </body>
</html>
