<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>18-Proxy - DefineOwnProperty</title>
  </head>
  <body>
    <script>
      //   "use strict";
      const obj = {
        a: 1,
        b: 2,
      };

      const proxy = new Proxy(obj, {
        defineProperty(target, prop, descriptor) {
          console.log(target); // {a: 1, b: 2}
          console.log(prop); // say
          console.log(descriptor); // {writable: true, configurable: true, value: ƒ}

          // Set prop on target.
          // Object.defineProperty(target, prop, descriptor);

          // must return Boolean.
          // - true: signal success.
          // - false: signal failure.

          // The defineProperty trap must either:
          //   - actually define the property on the target, OR
          //   - return false to signal failure.
          //
          // Returning true means “the property was correctly defined”.
          // If we return true without updating the target, the engine detects
          // this mismatch. For non-configurable properties this violates
          // object invariants and throws a TypeError.

          return true;
        },
      });

      // When using proxy for an object, it is advisable to use try...catch to prevent any error that causes the program to not execute.
      try {
        Object.defineProperty(proxy, "say", {
          value: function () {},
          writable: true,
          configurable: true,
          test: "test", // this is a random prop that is not part of the descriptor, it will be ignored.
        });
      } catch (err) {
        console.log(err);
      }

      try {
        Object.defineProperty(proxy, "name", {
          value: "twx",
          writable: false,
          configurable: false,
          // non-writable, non-configurable would throw if the proxy handler returns true, but there's no prop added.
        });
      } catch (err) {
        console.log(err); // TypeError: Cannot redefine property: name
      }

      // This only triggers [[SET]], not [[DefineOwnProperty]]
      obj.name = "twx";
      // throws in strict mode.
      // Uncaught TypeError: Cannot assign to read only property 'name' of object '#<Object>'
      console.log(obj);
    </script>
  </body>
</html>
