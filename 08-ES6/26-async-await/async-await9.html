<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Async Task 9: Concurrent Async Tasks</title>
  </head>
  <body>
    <script>
      // Concurrent: p1 p2 p3 makes progress at the same time
      const url1 = "http://localhost:8880/"; // Wrong URL
      const url2 = "http://localhost:8881/api/courses";
      const url3 = "http://localhost:8881/api/users";

      async function foo() {
        // Handling the request is concurrent
        // All requests are send out in the same time without waiting for the previous one to complete.
        // catch: make sure if one failed, doesn't affect the others.
        const p1 = fetch(url1).catch((err) => {
          console.log(err);
        }); // p1 is a resolved promise(undefined) after handling with catch(), it is undefined because we didn't return anything in catch().

        const p2 = fetch(url2).catch((err) => {
          console.log(err);
        });

        const p3 = fetch(url3).catch((err) => {
          console.log(err);
        });

        // Handling the response is sequential
        // Make sure res1 exists and status code is correct
        // Wait for them one by one
        let res1 = await p1;
        let res2 = await p2;
        let res3 = await p3;

        // Make sure res1 exists.
        if (res1 && res1.status === 200) {
          const data = await res1.json();
          console.log(data);
        }

        if (res2 && res2.status === 200) {
          const data = await res2.json();
          console.log(data);
        }

        if (res3 && res3.status === 200) {
          const data = await res3.json();
          console.log(data);
        }
      }

      foo();

      async function bar() {
        // Handling the request is concurrent
        // All requests are send out in the same time without waiting for the previous one to complete.
        // Note: you can use arr.map.
        const p1 = fetch(url1).catch((err) => {
          console.log(err);
        });

        const p2 = fetch(url2).catch((err) => {
          console.log(err);
        });

        const p3 = fetch(url3).catch((err) => {
          console.log(err);
        });

        // Wait for all of them
        // When we want to do something after all the responses have received
        let [res1, res2, res3] = await Promise.all([p1, p2, p3]);

        // Handling the response is sequential
        // Make sure res1 exists and status code is correct
        if (res1 && res1.status === 200) {
          const data = await res1.json();
          console.log(data);
        }

        if (res2 && res2.status === 200) {
          const data = await res2.json();
          console.log(data);
        }

        if (res3 && res3.status === 200) {
          const data = await res3.json();
          console.log(data);
        }
      }

      bar();
    </script>
  </body>
</html>
