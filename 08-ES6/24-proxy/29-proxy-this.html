<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>29-Proxy: this issue</title>
  </head>
  <body>
    <script type="module">
      import Stack from "./stack.js";
      const stack = new Stack(10);

      // Directly proxying an instance of Stack can cause issues with "this".
      const proxy = new Proxy(stack, {});

      stack.push(10); // Stack {size: 10}

      // "this" refers to proxy instead of stack instance after using proxy.
      //   proxy.push(10); // Proxy(Stack) {size: 10}
      //   Uncaught TypeError: Cannot read properties of undefined (reading 'push')

      // Proxying the class itself works fine because the constructor correctly sets "this".
      const proxy2 = new Proxy(Stack, {});
      const stack2 = new proxy2(20);
      console.log(stack2);
      stack2.push("a").push("b").push("c");

      console.log(stack2.view()); // ['a', 'b', 'c']
    </script>
    <script>
      // Some built-in objects cannot be proxied.
      // Their methods require "this" to be the actual instance, not a proxy.
      const date = new Date();
      console.log(date); // Sat Nov 29 2025 19:04:24 GMT+0800 (Malaysia Time)
      const proxy3 = new Proxy(date, {});
      proxy3.getDate(); // Uncaught TypeError: this is not a Date object.

      // This line will not run due to the error above.
      console.log("+++");
    </script>
    <script>
      const obj = {
        say() {
          if (this !== obj) {
            // This object cannot be safely proxied.
            // When using a proxy, "this" refers to the proxy instead of the original object.
            throw new Error("Cannot use Proxy on this obj.");
          }
          console.log(this);
        },
      };
      const proxy4 = new Proxy(obj, {});
      proxy4.say(); // Uncaught Error: Cannot use Proxy on this obj.

      // This line will not run due to the error above.
      console.log("+++");
    </script>
  </body>
</html>
