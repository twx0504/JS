<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>03-Generator - next</title>
  </head>
  <body>
    <script>
      function* gen() {
        let a = yield 1 + 2; // pause here. (yield (1 + 2) and give out 3
        console.log(a); // undefined
        let b = a + 2; // NaN (undefined + 2)
        console.log(b);
        let c = b + (yield 10); // pause here and give out 10.
        console.log(c);
      }

      const it = gen();
      it.next(); // NOTHING HAPPENS.
      it.next();
      // undefined
      // NaN
      it.next(); // NaN

      // We can pass a value to next method.
      // It is treated as the return value of the last yield statement.
      // Otherwise, the last yield statement is undefined.
      const it2 = gen();
      it2.next(); // NOTHING HAPPENS.
      it2.next(10); // value you passed in becomes the result of the last yield.
      // 10
      // 12
      it2.next(5); // 17 // value you passed in becomes the result of the last yield.

      // Application: AJAX

      // - Generator Function
      function* main() {
        let res = yield request(
          "https://cdn.britannica.com/84/232784-050-1769B477/Siberian-Husky-dog.jpg"
        ); // send request -> the AJAX response will be the yield return value.

        console.log(res);
        // res = JSON.parse(res);
        // for (let key in res) {
        //   console.log(res[key]);
        // }
      }

      function request(url) {
        // Example of checking whether data loads successfully (simulating AJAX):
        // Using Image object to illustrate async loading events.
        const img = new Image();
        // There will be an events as such to tell us the status.
        // Event fires when the image loads successfully
        img.onload = function () {
          console.log("img is loaded successfully.");
          let res = img.width; // Get the width of img.

          // You might wonder why `iter` is accessible here, even though it's declared after the `request` function.
          // That's because this line runs inside the setTimeout callback, which executes **after** `iter` is initialized.
          // TDZ only throws an error if the variable is accessed **before** initialization.
          // Call next again.
          iter.next(res); // Passing res as argument to iter.next method to be treated as the return value of the last yield statement.
        };
        // Event fires if the image fails to load
        img.onerror = function () {
          console.log("img loading is failed");
        };
        // Start loading the image by setting the URL
        img.src = url;

        // AJAX
        // ...
        // Mimick Getting response after 3 sec.
        // setTimeout(function () {
        //   let res = '{"name":"twx", "age": 25}'; // Mimick the response from AJAX.

        //   // You might wonder why `iter` is accessible here, even though it's declared after the `request` function.
        //   // That's because this line runs inside the setTimeout callback, which executes **after** `iter` is initialized.
        //   // TDZ only throws an error if the variable is accessed **before** initialization.
        // CALL NEXT again
        //   iter.next(res); // Passing res as argument to iter.next method to be treated as the return value of the last yield statement.
        // }, 3000);
      }

      const iter = main(); // initialization.
      iter.next(); // it runs the generator (main) body.
    </script>
  </body>
</html>
